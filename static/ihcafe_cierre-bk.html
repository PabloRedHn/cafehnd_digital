<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Caf√©HND Digital - IHCAFE - Cierres Diarios</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        :root {
            --ihcafe-green: #4b2e2a;
            --ihcafe-bg: #e0f0f8;
            --success: #d4edda;
            --error: #f8d7da;
            --warning: #fff3cd;
            --info: #d1ecf1;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--ihcafe-bg);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: var(--ihcafe-green);
        }
        .section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            font-size: 0.9em;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }
        /* Ajuste para el campo de fecha */
        input[type="date"] {
            width: auto;
            padding: 8px;
        }
        /* Estilo espec√≠fico para campos num√©ricos */
        input[type="number"] {
             text-align: right; /* Alinear a la derecha para n√∫meros */
        }
        button {
            margin-top: 20px;
            padding: 12px 20px;
            background-color: var(--ihcafe-green);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #361d1c;
        }
        #resultado {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        .error {
            background-color: var(--error);
            color: #721c24;
        }
        .success {
            background-color: var(--success);
            color: #155724;
        }
        .info-box {
            background-color: var(--warning);
            padding: 15px;
            border-left: 5px solid #ffc107;
            margin-top: 20px;
            font-size: 0.9em;
        }
        .info-box-blue {
            background-color: var(--info);
            padding: 15px;
            border-left: 5px solid #17a2b8;
            margin-top: 20px;
            font-size: 0.9em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .readonly {
            background-color: #f9f9f9;
            font-size: 0.9em;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        .form-group-half {
            flex: 0 0 calc(50% - 10px);
        }
        .form-group-small {
            flex: 0 0 150px;
        } /* Para la fecha */
        .form-group-medium {
            flex: 0 0 200px;
        }
        .form-group-full {
            flex: 1 100%;
        }
        .required::after {
            content: " *";
            color: red;
        }
        .tasa-bch-input {
            width: 120px;
        }
        .position-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }
        .position-table th, .position-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .position-table th {
            background-color: #f2f2f2;
        }
        .position-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .position-table .close-input {
            width: 100px;
            text-align: right;
        }
        .loading {
            color: #007bff;
            font-style: italic;
        }
        #loading-indicator {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚òï IHCAFE - Cierres Diarios (NY ICE & BCH)</h1>
        <p>Ingrese o modifique los datos oficiales del d√≠a anterior para c√°lculos de exportadores.</p>

        <!-- Secci√≥n: √öltimo Cierre -->
        <div class="section">
            <h2>üìÖ √öltimo Cierre Registrado</h2>
            <div id="ultimo-cierre-placeholder">
                <!-- Este div se actualizar√° con HTMX -->
                <p>Cargando √∫ltimo cierre...</p>
            </div>
        </div>

        <!-- Secci√≥n: Ingresar/Modificar Cierre -->
        <div class="section">
            <h2>‚ûï Registrar/Modificar Cierre</h2>
            <form id="form-cierre">
                <div class="form-row">
                    <div class="form-group form-group-small">
                        <label for="fecha" class="required">Fecha de Cierre:</label>
                        <input type="date" id="fecha" name="fecha" required>
                    </div>
                    
                    <div class="form-group form-group-medium">
                        <label for="tasa_cambio_bch" class="required">Tasa BCH (Lps/USD):</label>
                        <input type="text" id="tasa_cambio_bch" name="tasa_cambio_bch" placeholder="Ej: 24.5500" class="tasa-bch-input" required>
                        <div class="readonly">Fuente: Banco Central de Honduras</div>
                    </div>
                </div>

                <!-- Tabla de Posiciones ICE -->
                <div class="section">
                    <h3>üìã Posiciones ICE - Precios de Cierre (Close#)</h3>
                    <p>Ingrese el valor del precio de cierre (<strong>CLOSE#</strong>) para cada posici√≥n.</p>
                    <div id="loading-indicator" class="loading">Cargando datos...</div>
                    <table class="position-table" id="positions-table">
                        <thead>
                            <tr>
                                <th>Mes de Contrato</th>
                                <th>Precio de Cierre (Close#)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Diciembre-2024</strong></td>
                                <td><input type="text" name="precio_posicion_dic24" placeholder="Ej: 150.50" class="close-input"></td>
                            </tr>
                            <tr>
                                <td><strong>Marzo-2025</strong></td>
                                <td><input type="text" name="precio_posicion_mar25" placeholder="Ej: 151.00" class="close-input"></td>
                            </tr>
                            <tr>
                                <td><strong>Mayo-2025</strong></td>
                                <td><input type="text" name="precio_posicion_may25" placeholder="Ej: 151.50" class="close-input"></td>
                            </tr>
                            <tr>
                                <td><strong>Julio-2025</strong></td>
                                <td><input type="text" name="precio_posicion_jul25" placeholder="Ej: 152.00" class="close-input"></td>
                            </tr>
                            <tr>
                                <td><strong>Septiembre-2025</strong></td>
                                <td><input type="text" name="precio_posicion_sep25" placeholder="Ej: 152.50" class="close-input"></td>
                            </tr>
                            <tr>
                                <td><strong>Diciembre-2025</strong></td>
                                <td><input type="text" name="precio_posicion_dic25" placeholder="Ej: 153.00" class="close-input"></td>
                            </tr>
                            <tr>
                                <td><strong>Marzo-2026</strong></td>
                                <td><input type="text" name="precio_posicion_mar26" placeholder="Ej: 153.50" class="close-input"></td>
                            </tr>
                            <tr>
                                <td><strong>Mayo-2026</strong></td>
                                <td><input type="text" name="precio_posicion_may26" placeholder="Ej: 154.00" class="close-input"></td>
                            </tr>
                            <tr>
                                <td><strong>Julio-2026</strong></td>
                                <td><input type="text" name="precio_posicion_jul26" placeholder="Ej: 154.50" class="close-input"></td>
                            </tr>
                            <tr>
                                <td><strong>Septiembre-2026</strong></td>
                                <td><input type="text" name="precio_posicion_sep26" placeholder="Ej: 155.00" class="close-input"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Campos ocultos con valores predefinidos -->
                <input type="hidden" name="fuente_precio" value="ICE Futures">
                <input type="hidden" name="fuente_tasa" value="Banco Central de Honduras">

                <button type="button" id="guardar-btn">üíæ Guardar/Actualizar Cierre</button>
            </form>
            <div id="resultado"></div>
        </div>

        <div class="info-box-blue">
            <strong>‚ÑπÔ∏è Procedimiento:</strong>
            <ul>
                <li>Ingrese los datos del <strong>cierre del d√≠a anterior</strong> (precio NY ICE y tasa BCH del d√≠a h√°bil anterior).</li>
                <li>La <strong>fecha</strong> corresponde al d√≠a del cierre (por ejemplo, si ingresa datos el Martes, la fecha es del Lunes).</li>
                <li>La <strong>tasa BCH</strong> debe tener <strong>4 decimales</strong> (ej: 24.5500).</li>
                <li>Ingrese el <strong>precio de cierre (CLOSE#)</strong> para cada posici√≥n futura del NY ICE.</li>
                <li>Si ingresa una fecha existente, el registro se <strong>actualizar√°</strong>.</li>
            </ul>
        </div>
        <div class="info-box">
            <strong>üí° Notas:</strong>
            <ul>
                <li>Los campos "Fuente del Precio" y "Fuente de la Tasa" se llenan autom√°ticamente.</li>
                <li>El sistema verificar√° si ya existe un cierre para la fecha seleccionada y lo mostrar√° para edici√≥n.</li>
            </ul>
        </div>
    </div>

    <script>
        // --- Configuraci√≥n ---
        const BASE_URL = ""; // Se asume que el script corre desde el mismo dominio
        const POSICIONES_ICE_KEYS = [
            "dic24", "mar25", "may25", "jul25", "sep25",
            "dic25", "mar26", "may26", "jul26", "sep26"
        ];

        // --- Funciones Auxiliares ---
        function mostrarResultado(mensaje, esExito = true) {
            const divResultado = document.getElementById('resultado');
            divResultado.innerHTML = `<div class="${esExito ? 'success' : 'error'}">${mensaje}</div>`;
            setTimeout(() => { divResultado.innerHTML = ''; }, 5000); // Limpiar despu√©s de 5 segundos
        }

        function limpiarFormulario(limpiarFecha = true) {
            const form = document.getElementById('form-cierre');
            const elementos = form.elements;
            for (let i = 0; i < elementos.length; i++) {
                const elemento = elementos[i];
                if (elemento.type !== "hidden") {
                    if (elemento.type === "date" && !limpiarFecha) {
                        // No limpiar la fecha si no se indica
                    } else {
                        elemento.value = '';
                    }
                }
            }
        }

        // --- Inicializaci√≥n al cargar la p√°gina ---
        document.addEventListener('DOMContentLoaded', function () {
            console.log("Interfaz IHCAFE Cierre cargada.");

            // 1. Establecer fecha actual como predeterminada
            const hoy = new Date();
            const a√±o = hoy.getFullYear();
            const mes = String(hoy.getMonth() + 1).padStart(2, '0');
            const dia = String(hoy.getDate()).padStart(2, '0');
            document.getElementById('fecha').value = `${a√±o}-${mes}-${dia}`;

            // 2. Asignar evento change a la fecha para cargar datos
            document.getElementById('fecha').addEventListener('change', function () {
                const fechaSeleccionada = this.value;
                if (fechaSeleccionada) {
                    cargarDatosPorFecha(fechaSeleccionada);
                }
            });

            // 3. Asignar evento click al bot√≥n de guardar
            document.getElementById('guardar-btn').addEventListener('click', guardarCierre);

            // 4. Cargar datos para la fecha predeterminada
            setTimeout(() => {
                const fechaPredeterminada = document.getElementById('fecha').value;
                if (fechaPredeterminada) {
                    cargarDatosPorFecha(fechaPredeterminada);
                }
            }, 500); // Peque√±o retraso para asegurar que todo est√© listo

            // 5. Asignar validaci√≥n en tiempo real a los campos num√©ricos
            document.getElementById('tasa_cambio_bch').addEventListener('input', function(e) {
                let valor = e.target.value.replace(/[^0-9.]/g, ''); // Solo n√∫meros y punto
                const partes = valor.split('.');
                if (partes.length > 2) {
                    valor = partes[0] + '.' + partes.slice(1).join(''); // Evitar m√∫ltiples puntos
                }
                if (partes[1] && partes[1].length > 4) {
                     valor = partes[0] + '.' + partes[1].substring(0, 4); // Limitar a 4 decimales
                }
                e.target.value = valor;
            });

            POSICIONES_ICE_KEYS.forEach(key => {
                const input = document.querySelector(`input[name="precio_posicion_${key}"]`);
                if (input) {
                    input.addEventListener('input', function(e) {
                        let valor = e.target.value.replace(/[^0-9.]/g, '');
                        const partes = valor.split('.');
                        if (partes.length > 2) {
                            valor = partes[0] + '.' + partes.slice(1).join('');
                        }
                        if (partes[1] && partes[1].length > 2) {
                             valor = partes[0] + '.' + partes[1].substring(0, 2); // Limitar a 2 decimales para precios
                        }
                        e.target.value = valor;
                    });
                }
            });

        });

        // --- Funci√≥n para cargar datos cuando se cambia la fecha ---
        async function cargarDatosPorFecha(fecha) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const divResultado = document.getElementById('resultado');
            const url = `${BASE_URL}/cierre_ny_bch/por_fecha/${fecha}`;

            if (loadingIndicator) loadingIndicator.style.display = 'block';
            if (divResultado) divResultado.innerHTML = '';

            try {
                const response = await fetch(url);
                console.log(`[FETCH] GET ${url} - Status: ${response.status}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log("[FETCH] Datos recibidos:", data);

                    // Limpiar formulario antes de cargar (excepto la fecha)
                    limpiarFormulario(false);

                    // Rellenar campos del formulario con los datos recibidos
                    document.getElementById('tasa_cambio_bch').value = data.tasa_cambio_bch !== null ? data.tasa_cambio_bch.toFixed(4) : '';

                    // Rellenar campos de posiciones ICE
                    POSICIONES_ICE_KEYS.forEach(key => {
                        const input = document.querySelector(`input[name="precio_posicion_${key}"]`);
                        if (input) {
                            const valor = data[`precio_posicion_${key}`];
                            input.value = valor !== null ? valor.toFixed(2) : ''; // Mostrar con 2 decimales
                        }
                    });

                    if (divResultado) {
                        divResultado.innerHTML = `<div class="success">‚úÖ Datos para la fecha ${fecha} cargados.</div>`;
                    }
                    console.log(`[INFO] Datos cargados para la fecha: ${fecha}`);
                } else if (response.status === 404) {
                    console.log(`[WARN] No se encontr√≥ registro para la fecha: ${fecha}`);
                    limpiarFormulario(false); // Limpiar solo los campos de datos, no la fecha
                    // No mostrar error, solo dejar el formulario limpio
                } else {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText || response.statusText}`);
                }
            } catch (error) {
                console.error(`[ERROR] Error al cargar datos para la fecha ${fecha}:`, error);
                if (divResultado) {
                    divResultado.innerHTML = `<div class="error">‚ùå Error al cargar datos para ${fecha}: ${error.message}</div>`;
                }
            } finally {
                if (loadingIndicator) loadingIndicator.style.display = 'none';
            }
        }

        // --- Funci√≥n para guardar/actualizar el cierre ---
        async function guardarCierre() {
            console.log("[DEBUG] Iniciando proceso de guardado...");
            const form = document.getElementById('form-cierre');
            const fechaInput = document.getElementById('fecha');
            const tasaInput = document.getElementById('tasa_cambio_bch');
            const divResultado = document.getElementById('resultado');

            const fecha = fechaInput.value;
            if (!fecha) {
                mostrarResultado("‚ùå Por favor, seleccione una fecha.", false);
                return;
            }

            // 1. Recolectar y preparar datos del formulario
            const formData = new FormData(form);
            const data = {};

            // Procesar la tasa BCH
            const tasaValor = formData.get('tasa_cambio_bch');
            if (tasaValor && tasaValor.trim() !== '') {
                 const tasaNumerica = parseFloat(tasaValor);
                 if (isNaN(tasaNumerica)) {
                      mostrarResultado(`‚ùå El valor de la Tasa BCH '${tasaValor}' no es un n√∫mero v√°lido.`, false);
                      return;
                 }
                 data['tasa_cambio_bch'] = tasaNumerica;
            } else {
                 data['tasa_cambio_bch'] = null;
            }

            // Procesar las posiciones ICE
            for (const key of POSICIONES_ICE_KEYS) {
                 const valorStr = formData.get(`precio_posicion_${key}`);
                 if (valorStr && valorStr.trim() !== '') {
                      const valorNumerico = parseFloat(valorStr);
                      if (isNaN(valorNumerico)) {
                           mostrarResultado(`‚ùå El valor del precio para ${key.toUpperCase()} '${valorStr}' no es un n√∫mero v√°lido.`, false);
                           return;
                      }
                      data[`precio_posicion_${key}`] = valorNumerico;
                 } else {
                      data[`precio_posicion_${key}`] = null;
                 }
            }

            // Agregar otros campos del formulario (fecha, fuentes)
            data['fecha'] = formData.get('fecha');
            data['fuente_precio'] = formData.get('fuente_precio');
            data['fuente_tasa'] = formData.get('fuente_tasa');

            console.log("[DEBUG] Datos a enviar:", data);

            const url = `${BASE_URL}/cierre_ny_bch/`;
            if (divResultado) divResultado.innerHTML = '<div class="info">üì° Enviando datos...</div>';

            try {
                console.log(`[FETCH] POST ${url}`);
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                console.log(`[FETCH] Respuesta del servidor: ${response.status}`);
                if (response.ok) {
                    const responseData = await response.json();
                    console.log("[FETCH] Respuesta JSON del servidor:", responseData);
                    mostrarResultado(`‚úÖ Cierre guardado/actualizado correctamente para la fecha ${responseData.fecha}.`);
                    console.log(`[INFO] Cierre guardado/actualizado para la fecha: ${responseData.fecha}`);
                    
                    // Opcional: Recargar el √∫ltimo cierre mostrado
                    // Esto requerir√≠a un endpoint espec√≠fico o recargar la secci√≥n con HTMX
                    // Por ahora, solo mostramos el mensaje.
                    
                } else {
                    const errorText = await response.text();
                    console.error(`[ERROR] Error del servidor: ${response.status} - ${errorText}`);
                    throw new Error(`Error ${response.status}: ${errorText || response.statusText}`);
                }
            } catch (error) {
                console.error("[ERROR] Error al guardar el cierre:", error);
                mostrarResultado(`‚ùå Error al guardar el cierre: ${error.message}`, false);
            }
        }
    </script>
</body>
</html>
